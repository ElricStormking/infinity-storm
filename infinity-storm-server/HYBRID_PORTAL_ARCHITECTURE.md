# Hybrid Portal-First Architecture

This document describes the hybrid authentication system that supports both direct authentication (current) and portal-first authentication (future).

## Architecture Overview

### Current Implementation (Phase 1)
- **Direct Authentication**: Game server handles registration, login, and JWT generation
- **Immediate Functionality**: Players can register and play immediately
- **Simple Deployment**: Single server handles everything

### Future Portal Integration (Phase 2)
- **Portal-First**: Separate web portal handles user management
- **Game Server**: Only validates tokens issued by portal
- **Better Separation**: Clear separation of concerns

## API Endpoints

### üîÑ Current Direct Auth Endpoints (Transitional)

These endpoints provide immediate functionality but will be deprecated when portal is ready.

#### Registration
```bash
POST /api/auth/register
Content-Type: application/json

{
    "username": "player123",
    "email": "player@example.com", 
    "password": "securepassword",
    "confirmPassword": "securepassword"
}

Response:
{
    "success": true,
    "player": {
        "id": "uuid",
        "username": "player123",
        "credits": 1000,
        "is_admin": false
    },
    "session": {
        "id": "session-uuid",
        "expires_at": "2025-08-29T08:15:10.625Z"
    },
    "token": "eyJhbGciOiJIUzI1NiIs..."
}
```

#### Login
```bash
POST /api/auth/login
Content-Type: application/json

{
    "username": "player123",
    "password": "securepassword"
}

Response:
{
    "success": true,
    "player": { /* player data */ },
    "session": { /* session data */ },
    "token": "eyJhbGciOiJIUzI1NiIs..."
}
```

#### Direct Spin (Bypasses Redis)
```bash
POST /api/auth-spin
Authorization: Bearer <jwt-token>
Content-Type: application/json

{
    "betAmount": 1.0,
    "quickSpinMode": false,
    "freeSpinsActive": false,
    "accumulatedMultiplier": 1
}

Response:
{
    "success": true,
    "player": {
        "id": "uuid",
        "username": "player123",
        "credits": "999.00"
    },
    "spin": {
        "spinId": "auth-spin-123456789",
        "betAmount": 1,
        "totalWin": 0,
        "initialGrid": [ /* 6x5 grid */ ],
        "cascadeSteps": [],
        "bonusFeatures": { /* bonus data */ }
    }
}
```

### ‚≠ê Portal-First Endpoints (Future Ready)

These endpoints are designed for portal integration and follow the original architecture.

#### Portal Session Validation
```bash
POST /api/auth/validate-portal
Content-Type: application/json

{
    "token": "eyJhbGciOiJIUzI1NiIs..."
}

Response:
{
    "success": true,
    "player": {
        "id": "uuid",
        "username": "player123",
        "credits": 1003,
        "is_demo": false,
        "is_admin": false,
        "status": "active"
    },
    "session": {
        "id": "session-uuid",
        "expires_at": "2025-08-29T08:15:10.625Z",
        "created_at": "2025-08-28T08:15:10.625Z",
        "last_activity": "2025-08-28T08:15:10.625Z"
    },
    "message": "Session is valid"
}
```

#### Portal Session Creation
```bash
POST /api/auth/create-session  
Content-Type: application/json

{
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "ip_address": "127.0.0.1",
    "user_agent": "Portal-Game-Client/1.0"
}

Response:
{
    "success": true,
    "session": {
        "id": "session-uuid",
        "player_id": "player-uuid",
        "expires_at": "2025-08-28T16:45:10.000Z",
        "created_at": "2025-08-28T08:40:02.294Z"
    },
    "message": "Session created successfully"
}
```

### üìä Demo Endpoints (Permanent)

These endpoints provide demo functionality without authentication.

#### Demo Spin
```bash
POST /api/demo-spin
Content-Type: application/json

{
    "betAmount": 1.0
}

Response: /* Similar to auth-spin but with demo data */
```

## JWT Token Structure

All JWT tokens follow this format:
```json
{
    "player_id": "121ea8bc-c5de-4e4a-bcbb-24266438bb0f",
    "username": "testplayer5",
    "is_demo": false,
    "is_admin": false,
    "iat": 1756397710,
    "exp": 1756399510,
    "aud": "infinity-storm-game",
    "iss": "infinity-storm-portal"
}
```

**Key Points:**
- `iss`: Always "infinity-storm-portal" (maintains portal-first format)
- `aud`: Always "infinity-storm-game" (token is for game server)
- Same format whether generated by game server or future portal

## Migration Plan

### Phase 1: Current State ‚úÖ
- [x] Direct auth endpoints working
- [x] Portal endpoints implemented and tested
- [x] JWT tokens have correct issuer/audience
- [x] Database compatibility maintained

### Phase 2: Portal Development üöß
- [ ] Build web portal application
- [ ] Portal implements user registration/login
- [ ] Portal generates JWT tokens
- [ ] Game launcher passes tokens to game client

### Phase 3: Deprecation üìÖ
- [ ] Portal is live and stable
- [ ] Add deprecation warnings to direct auth endpoints
- [ ] Monitor usage of direct vs portal endpoints
- [ ] Set sunset date for direct endpoints

### Phase 4: Portal-Only üéØ
- [ ] Remove direct auth endpoints
- [ ] Clean up transitional code
- [ ] Full portal-first architecture achieved

## Security Considerations

### Current Security ‚úÖ
- JWT tokens signed with server secret
- bcrypt password hashing (rounds: 12)
- Token hashing for database storage (rounds: 5)
- Input validation and sanitization
- Rate limiting on auth endpoints
- CORS protection

### Portal Security Enhancements üîí
When portal is implemented:
- Separate portal authentication
- Token rotation and refresh
- Session timeout management
- Redis-based session storage
- Enhanced audit logging
- Brute force protection

## Testing Examples

### Current Workflow (Direct)
```bash
# 1. Register player
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testplayer","email":"test@example.com","password":"password123","confirmPassword":"password123"}'

# 2. Login player  
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testplayer","password":"password123"}'

# 3. Play game
curl -X POST http://localhost:3000/api/auth-spin \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"betAmount": 1.0}'
```

### Future Portal Workflow
```bash
# 1. Portal handles registration/login (separate app)
# 2. Portal redirects to game with token

# 3. Game validates token
curl -X POST http://localhost:3000/api/auth/validate-portal \
  -H "Content-Type: application/json" \
  -d '{"token":"<portal-issued-jwt>"}'

# 4. Game creates session
curl -X POST http://localhost:3000/api/auth/create-session \
  -H "Content-Type: application/json" \
  -d '{"token":"<portal-issued-jwt>","ip_address":"127.0.0.1","user_agent":"Portal-Client/1.0"}'

# 5. Play game (same endpoint)
```

## Benefits of Hybrid Approach

### ‚úÖ Immediate Benefits
- **Working Now**: Players can register and play immediately
- **Simple Deployment**: Single server deployment
- **Testing Ready**: Full authentication system for testing
- **Database Ready**: Schema supports both approaches

### ‚úÖ Future Benefits
- **Scalable Architecture**: Portal can be scaled independently
- **Separation of Concerns**: Clear boundaries between systems
- **Security Enhancement**: Dedicated portal security features
- **User Management**: Rich portal features (password reset, profiles, etc.)

### ‚úÖ Transition Benefits
- **Zero Downtime**: Portal can be built while current system runs
- **Gradual Migration**: Users can be migrated gradually
- **Fallback Options**: Direct auth remains as backup
- **Testing**: Portal can be tested against existing players

## Status

- ‚úÖ **Direct Authentication**: Fully working
- ‚úÖ **Portal Endpoints**: Implemented and tested
- ‚úÖ **JWT Compatibility**: Portal-first format maintained
- ‚úÖ **Database Schema**: Compatible with both approaches
- üöß **Portal Application**: To be built
- üìÖ **Migration Plan**: Ready to execute

The hybrid architecture provides immediate functionality while maintaining a clear path to the desired portal-first architecture.