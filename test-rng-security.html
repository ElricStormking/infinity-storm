<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RNG Security Test - Infinity Storm</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #444; background: #2a2a2a; }
        .pass { border-color: #4CAF50; background: #1b4f1b; }
        .fail { border-color: #f44336; background: #4f1b1b; }
        .warn { border-color: #ff9800; background: #4f3b1b; }
        pre { background: #333; padding: 10px; margin: 10px 0; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        .stats { background: #333; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîí RNG Security Test - Phase 1 Validation</h1>
    <p>This test validates that Phase 1 RNG Security Fixes are working correctly.</p>
    
    <div id="results"></div>
    
    <div class="stats">
        <h3>Test Controls</h3>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="testDirectMathRandom()">Test Math.random() Detection</button>
        <button onclick="testRNGConsolidation()">Test RNG Consolidation</button>
        <button onclick="showSecurityStats()">Show Security Stats</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <!-- Load the RNG system -->
    <script src="src/engine/RNG.js"></script>
    <script src="src/engine/SymbolSource.js"></script>
    <script src="GameConfig.js"></script>
    <script src="Paytable.js"></script>

    <script>
        const results = document.getElementById('results');
        
        function addResult(title, content, status = 'info') {
            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.innerHTML = `<h4>${title}</h4><div>${content}</div>`;
            results.appendChild(div);
        }
        
        function clearResults() {
            results.innerHTML = '';
        }
        
        function runAllTests() {
            clearResults();
            addResult('üöÄ Running Phase 1 RNG Security Tests', 'Starting comprehensive security validation...', 'info');
            
            // Test 1: RNG System Availability
            testRNGAvailability();
            
            // Test 2: Math.random() Detection
            testDirectMathRandom();
            
            // Test 3: RNG Consolidation
            testRNGConsolidation();
            
            // Test 4: SymbolSource Integration
            testSymbolSourceIntegration();
            
            // Test 5: Security Monitoring
            testSecurityMonitoring();
            
            // Final Stats
            setTimeout(showSecurityStats, 100);
        }
        
        function testRNGAvailability() {
            try {
                if (typeof window.RNG === 'function') {
                    const rng = new window.RNG();
                    const value = rng.random();
                    if (typeof value === 'number' && value >= 0 && value < 1) {
                        addResult('‚úÖ RNG System Available', 'window.RNG is properly loaded and functional', 'pass');
                    } else {
                        addResult('‚ùå RNG Invalid Output', `Expected number 0-1, got: ${value}`, 'fail');
                    }
                } else {
                    addResult('‚ùå RNG Not Available', 'window.RNG is not loaded or not a function', 'fail');
                }
            } catch (error) {
                addResult('‚ùå RNG System Error', `Error testing RNG: ${error.message}`, 'fail');
            }
        }
        
        function testDirectMathRandom() {
            const originalConsoleError = console.error;
            let securityViolationDetected = false;
            
            // Capture security violation
            console.error = function(...args) {
                if (args[0] && args[0].includes('SECURITY VIOLATION')) {
                    securityViolationDetected = true;
                }
                originalConsoleError.apply(console, args);
            };
            
            try {
                // This should trigger the security violation
                const value = Math.random();
                
                setTimeout(() => {
                    console.error = originalConsoleError;
                    if (securityViolationDetected) {
                        addResult('‚úÖ Math.random() Detection Working', 'Direct Math.random() calls are properly detected and logged', 'pass');
                    } else {
                        addResult('‚ö†Ô∏è Math.random() Detection May Not Be Working', 'No security violation was detected - check console', 'warn');
                    }
                }, 50);
                
            } catch (error) {
                console.error = originalConsoleError;
                addResult('‚ùå Math.random() Test Error', `Error testing Math.random(): ${error.message}`, 'fail');
            }
        }
        
        function testRNGConsolidation() {
            try {
                // Test different RNG methods
                const rng = new window.RNG();
                
                // Test random()
                const randomValue = rng.random();
                const randomValid = typeof randomValue === 'number' && randomValue >= 0 && randomValue < 1;
                
                // Test int()
                const intValue = rng.int(1, 10);
                const intValid = Number.isInteger(intValue) && intValue >= 1 && intValue <= 10;
                
                // Test chance()
                const chanceTrue = rng.chance(1.0);  // Should always be true
                const chanceFalse = rng.chance(0.0); // Should always be false
                const chanceValid = chanceTrue === true && chanceFalse === false;
                
                // Test weighted()
                const weights = { a: 100, b: 0 }; // 'a' should always win
                const weightedValue = rng.weighted(weights);
                const weightedValid = weightedValue === 'a';
                
                if (randomValid && intValid && chanceValid && weightedValid) {
                    addResult('‚úÖ RNG Methods Consolidated', `
                        <pre>random(): ${randomValue} ‚úì
int(1,10): ${intValue} ‚úì  
chance(1.0): ${chanceTrue} ‚úì
chance(0.0): ${chanceFalse} ‚úì
weighted({a:100, b:0}): ${weightedValue} ‚úì</pre>`, 'pass');
                } else {
                    addResult('‚ùå RNG Method Issues', `
                        <pre>random(): ${randomValue} ${randomValid ? '‚úì' : '‚úó'}
int(1,10): ${intValue} ${intValid ? '‚úì' : '‚úó'}
chance(1.0): ${chanceTrue} ${chanceValid ? '‚úì' : '‚úó'}
weighted(): ${weightedValue} ${weightedValid ? '‚úì' : '‚úó'}</pre>`, 'fail');
                }
                
            } catch (error) {
                addResult('‚ùå RNG Consolidation Error', `Error testing RNG methods: ${error.message}`, 'fail');
            }
        }
        
        function testSymbolSourceIntegration() {
            try {
                if (typeof window.SymbolSource === 'function' && typeof window.Paytable === 'object') {
                    const rng = new window.RNG();
                    const symbolSource = new window.SymbolSource(rng);
                    
                    // Test that SymbolSource can generate symbols
                    const symbols = [];
                    for (let i = 0; i < 10; i++) {
                        symbols.push(symbolSource.rollOne());
                    }
                    
                    const uniqueSymbols = [...new Set(symbols)];
                    const validSymbols = symbols.every(symbol => typeof symbol === 'string' && symbol.length > 0);
                    
                    if (validSymbols && uniqueSymbols.length > 1) {
                        addResult('‚úÖ SymbolSource Integration', `
                            <pre>Generated 10 symbols: [${symbols.join(', ')}]
Unique symbols: ${uniqueSymbols.length}
All valid: ${validSymbols}</pre>`, 'pass');
                    } else {
                        addResult('‚ö†Ô∏è SymbolSource Concerns', `Generated symbols may lack variety: ${uniqueSymbols.length} unique from 10 rolls`, 'warn');
                    }
                } else {
                    addResult('‚ùå SymbolSource Not Available', 'SymbolSource or Paytable not properly loaded', 'fail');
                }
            } catch (error) {
                addResult('‚ùå SymbolSource Error', `Error testing SymbolSource: ${error.message}`, 'fail');
            }
        }
        
        function testSecurityMonitoring() {
            try {
                if (typeof window.RNG.getSecurityStats === 'function') {
                    // Reset stats for clean test
                    window.RNG.resetSecurityStats();
                    
                    // Generate some RNG calls
                    const rng1 = new window.RNG(); // Unseeded
                    const rng2 = new window.RNG('test-seed'); // Seeded
                    
                    rng1.random(); // This should count as unauthorized
                    rng2.random(); // This should count as authorized
                    
                    const stats = window.RNG.getSecurityStats();
                    
                    addResult('‚úÖ Security Monitoring Active', `
                        <pre>Total RNG Calls: ${stats.totalCalls}
Unauthorized Calls: ${stats.unauthorizedCalls}
Security Ratio: ${(stats.securityRatio * 100).toFixed(1)}%</pre>`, 'pass');
                } else {
                    addResult('‚ùå Security Monitoring Not Available', 'RNG.getSecurityStats() method not found', 'fail');
                }
            } catch (error) {
                addResult('‚ùå Security Monitoring Error', `Error testing security monitoring: ${error.message}`, 'fail');
            }
        }
        
        function showSecurityStats() {
            if (typeof window.RNG.getSecurityStats === 'function') {
                const stats = window.RNG.getSecurityStats();
                addResult('üìä Current Security Statistics', `
                    <pre>Total RNG Calls: ${stats.totalCalls}
Unauthorized Calls: ${stats.unauthorizedCalls}
Security Ratio: ${(stats.securityRatio * 100).toFixed(1)}%

${stats.securityRatio > 0.5 ? '‚ö†Ô∏è  HIGH UNAUTHORIZED USAGE DETECTED' : '‚úÖ Security ratio is acceptable'}</pre>`, 
                    stats.securityRatio > 0.5 ? 'warn' : 'pass');
            } else {
                addResult('‚ùå Stats Not Available', 'Security stats not available', 'fail');
            }
        }
        
        // Auto-run tests on load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>